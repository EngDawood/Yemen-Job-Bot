{
  "name": "2. CV Upload & Profile Extraction",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "callback_query",
          "message"
        ],
        "additionalFields": {}
      },
      "name": "CV Upload Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "cv-upload-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.callback_query?.data }}",
              "value2": "upload_cv"
            },
            {
              "value1": "={{ $json.message?.text }}",
              "operation": "startsWith",
              "value2": "/profile"
            }
          ]
        },
        "combineOperation": "any"
      },
      "name": "Check CV Upload Request",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.callback_query?.message?.chat?.id || $json.message?.chat?.id }}",
        "text": "Ø±Ø§Ø¦Ø¹! ğŸ“„\n\nØ£Ø±Ø³Ù„ Ù„ÙŠ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ø¨Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø·Ø±Ù‚:\n\n1ï¸âƒ£ ÙƒÙ…Ù„Ù PDF Ø£Ùˆ Word\n2ï¸âƒ£ ÙƒÙ†Øµ Ù…Ø¨Ø§Ø´Ø±\n3ï¸âƒ£ ØµÙˆØ±Ø© (Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ)\n\nØ³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„Ù‡Ø§ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹."
      },
      "name": "Request CV Upload",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "updates": ["message"],
        "additionalFields": {
          "download": true
        }
      },
      "name": "Wait for CV",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [900, 300],
      "webhookId": "cv-file-webhook"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.message.document !== undefined || $json.message.text !== undefined || $json.message.photo !== undefined }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Check File Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©... â³\n\nÙ‡Ø°Ø§ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†."
      },
      "name": "Processing Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1340, 200]
    },
    {
      "parameters": {
        "functionCode": "// Extract text based on input type\nconst message = $input.item.json.message;\nlet cvText = '';\n\nif (message.text) {\n  // Plain text CV\n  cvText = message.text;\n} else if (message.document) {\n  // File uploaded - will be processed by next node\n  cvText = 'FILE_TO_PROCESS';\n} else if (message.photo) {\n  // Photo uploaded - OCR needed\n  cvText = 'PHOTO_TO_PROCESS';\n}\n\nreturn {\n  json: {\n    telegram_id: message.from.id,\n    chat_id: message.chat.id,\n    cv_text: cvText,\n    file_id: message.document?.file_id || message.photo?.[message.photo.length - 1]?.file_id,\n    file_type: message.document?.mime_type || 'image',\n    file_name: message.document?.file_name || 'photo.jpg'\n  }\n};"
      },
      "name": "Extract CV Content",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1340, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "queryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{ $env.ADMIN_GEMINI_KEY }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": \"Extract structured information from this CV/Resume. Return ONLY valid JSON with this exact structure:\\n\\n{\\n  \\\"full_name\\\": \\\"string\\\",\\n  \\\"email\\\": \\\"string or null\\\",\\n  \\\"phone\\\": \\\"string or null\\\",\\n  \\\"location\\\": \\\"string or null\\\",\\n  \\\"summary\\\": \\\"string or null\\\",\\n  \\\"skills\\\": [\\\"skill1\\\", \\\"skill2\\\"],\\n  \\\"languages\\\": [{\\\"language\\\": \\\"Arabic\\\", \\\"level\\\": \\\"Native\\\"}],\\n  \\\"education\\\": [{\\n    \\\"degree\\\": \\\"string\\\",\\n    \\\"field\\\": \\\"string\\\",\\n    \\\"institution\\\": \\\"string\\\",\\n    \\\"year\\\": \\\"string\\\",\\n    \\\"grade\\\": \\\"string or null\\\"\\n  }],\\n  \\\"experience\\\": [{\\n    \\\"title\\\": \\\"string\\\",\\n    \\\"company\\\": \\\"string\\\",\\n    \\\"duration\\\": \\\"string\\\",\\n    \\\"description\\\": \\\"string\\\",\\n    \\\"achievements\\\": [\\\"string\\\"]\\n  }],\\n  \\\"certifications\\\": [\\\"cert1\\\", \\\"cert2\\\"],\\n  \\\"projects\\\": [{\\n    \\\"name\\\": \\\"string\\\",\\n    \\\"description\\\": \\\"string\\\",\\n    \\\"technologies\\\": [\\\"tech1\\\"]\\n  }],\\n  \\\"total_experience_years\\\": number\\n}\\n\\nCV Content:\\n{{ $json.cv_text }}\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.1,\n    \"maxOutputTokens\": 2000\n  }\n}",
        "options": {}
      },
      "name": "Parse CV with Gemini",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1560, 400]
    },
    {
      "parameters": {
        "functionCode": "// Parse Gemini response and extract JSON\nconst response = $input.item.json;\nconst text = response.candidates[0].content.parts[0].text;\n\n// Extract JSON from response (remove markdown code blocks if present)\nlet jsonText = text.trim();\nif (jsonText.startsWith('```json')) {\n  jsonText = jsonText.substring(7);\n}\nif (jsonText.startsWith('```')) {\n  jsonText = jsonText.substring(3);\n}\nif (jsonText.endsWith('```')) {\n  jsonText = jsonText.substring(0, jsonText.length - 3);\n}\n\ntry {\n  const profile = JSON.parse(jsonText.trim());\n  \n  return {\n    json: {\n      telegram_id: $input.first().json.telegram_id,\n      chat_id: $input.first().json.chat_id,\n      profile: profile,\n      original_cv: $input.first().json.cv_text,\n      extraction_success: true\n    }\n  };\n} catch (error) {\n  return {\n    json: {\n      telegram_id: $input.first().json.telegram_id,\n      chat_id: $input.first().json.chat_id,\n      error: 'Failed to parse CV',\n      extraction_success: false,\n      raw_response: text\n    }\n  };\n}"
      },
      "name": "Parse Gemini Response",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1780, 400]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.extraction_success }}",
              "value2": true
            }
          ]
        }
      },
      "name": "Check Extraction Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [2000, 400]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/users?telegram_id=eq.{{ $json.telegram_id }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SECRET_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.SUPABASE_SECRET_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"profile\": {{ JSON.stringify($json.profile) }},\n  \"original_cv_text\": {{ JSON.stringify($json.original_cv) }},\n  \"last_active\": \"{{ new Date().toISOString() }}\"\n}",
        "options": {}
      },
      "name": "Update User Profile",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2220, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! âœ…\n\nğŸ“‹ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬:\nâ€¢ Ø§Ù„Ø§Ø³Ù…: {{ $json.profile.full_name }}\nâ€¢ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª: {{ $json.profile.skills?.length || 0 }} Ù…Ù‡Ø§Ø±Ø©\nâ€¢ Ø§Ù„Ø®Ø¨Ø±Ø§Øª: {{ $json.profile.experience?.length || 0 }} ÙˆØ¸ÙŠÙØ©\nâ€¢ Ø§Ù„ØªØ¹Ù„ÙŠÙ…: {{ $json.profile.education?.length || 0 }} Ø´Ù‡Ø§Ø¯Ø©\nâ€¢ Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©: {{ $json.profile.total_experience_years || 0 }} Ø³Ù†Ø©\n\n{{ $json.profile.email ? 'ğŸ“§ ' + $json.profile.email : '' }}\n{{ $json.profile.phone ? 'ğŸ“± ' + $json.profile.phone : '' }}\n\nØ§Ù„Ø¢Ù† Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ ÙˆØ¸Ø§Ø¦Ù Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©! ğŸ¯",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "buttons": [
                {
                  "text": "ğŸ” Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©",
                  "callbackData": "show_jobs"
                }
              ]
            },
            {
              "buttons": [
                {
                  "text": "ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ",
                  "callbackData": "edit_profile"
                }
              ]
            }
          ]
        }
      },
      "name": "Success Notification",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [2440, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©. ğŸ˜”\n\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù†:\nâœ… Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© PDF Ø£Ùˆ Word\nâœ… Ø§Ù„Ù†Øµ ÙˆØ§Ø¶Ø­ ÙˆÙ‚Ø§Ø¨Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©\nâœ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù†Ø¸Ù…\n\nØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… /profile"
      },
      "name": "Error Notification",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [2220, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/user_interactions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SECRET_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.SUPABASE_SECRET_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"user_id\": \"{{ $json[0].id }}\",\n  \"action\": \"cv_uploaded\",\n  \"details\": {\n    \"skills_count\": {{ $json.profile.skills?.length || 0 }},\n    \"experience_count\": {{ $json.profile.experience?.length || 0 }},\n    \"total_years\": {{ $json.profile.total_experience_years || 0 }}\n  }\n}",
        "options": {}
      },
      "name": "Log CV Upload",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2440, 500]
    }
  ],
  "connections": {
    "CV Upload Trigger": {
      "main": [[{"node": "Check CV Upload Request", "type": "main", "index": 0}]]
    },
    "Check CV Upload Request": {
      "main": [[{"node": "Request CV Upload", "type": "main", "index": 0}]]
    },
    "Request CV Upload": {
      "main": [[{"node": "Wait for CV", "type": "main", "index": 0}]]
    },
    "Wait for CV": {
      "main": [[{"node": "Check File Type", "type": "main", "index": 0}]]
    },
    "Check File Type": {
      "main": [[
        {"node": "Processing Message", "type": "main", "index": 0},
        {"node": "Extract CV Content", "type": "main", "index": 0}
      ]]
    },
    "Extract CV Content": {
      "main": [[{"node": "Parse CV with Gemini", "type": "main", "index": 0}]]
    },
    "Parse CV with Gemini": {
      "main": [[{"node": "Parse Gemini Response", "type": "main", "index": 0}]]
    },
    "Parse Gemini Response": {
      "main": [[{"node": "Check Extraction Success", "type": "main", "index": 0}]]
    },
    "Check Extraction Success": {
      "main": [
        [{"node": "Update User Profile", "type": "main", "index": 0}],
        [{"node": "Error Notification", "type": "main", "index": 0}]
      ]
    },
    "Update User Profile": {
      "main": [[
        {"node": "Success Notification", "type": "main", "index": 0},
        {"node": "Log CV Upload", "type": "main", "index": 0}
      ]]
    }
  },
  "settings": {},
  "staticData": null,
  "pinData": {}
}
