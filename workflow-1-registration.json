{
  "name": "1. User Registration Workflow",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        240,
        300
      ],
      "webhookId": "telegram-bot-webhook",
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/start"
            },
            {
              "value1": "={{ $json.message.text }}",
              "operation": "startsWith",
              "value2": "/register"
            }
          ]
        },
        "combineOperation": "any"
      },
      "name": "Check Command",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "=Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªÙˆØ¸ÙŠÙ Ø§Ù„ÙŠÙ…Ù†ÙŠ! ðŸ‡¾ðŸ‡ª\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª ÙŠØ³Ø§Ø¹Ø¯Ùƒ ÙÙŠ:\nâœ… Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ\nâœ… ØªÙˆÙ„ÙŠØ¯ Ø³ÙŠØ±Ø© Ø°Ø§ØªÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©\nâœ… Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø¨Ù†Ù‚Ø±Ø© ÙˆØ§Ø­Ø¯Ø©\n\nÙ„Ù„Ø¨Ø¯Ø¡ØŒ Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "buttons": [
                {
                  "text": "ðŸ†• ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯",
                  "callbackData": "register_new"
                }
              ]
            },
            {
              "buttons": [
                {
                  "text": "â„¹ï¸ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©",
                  "callbackData": "help"
                }
              ]
            }
          ]
        }
      },
      "name": "Send Welcome Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        680,
        200
      ],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "callback_query"
        ]
      },
      "name": "Callback Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        240,
        500
      ],
      "webhookId": "telegram-callback-webhook",
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.callback_query.data }}",
              "value2": "register_new"
            }
          ]
        }
      },
      "name": "Check Register Callback",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        460,
        500
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.callback_query.message.chat.id }}",
        "text": "=Ø±Ø§Ø¦Ø¹! Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ðŸ“\n\nÙ…Ø§ Ù‡Ùˆ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ØŸ",
        "additionalFields": {
          "reply_markup": {
            "force_reply": true
          }
        }
      },
      "name": "Ask for Name",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        680,
        500
      ],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {
          "download": false
        }
      },
      "name": "Wait for Name",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        900,
        500
      ],
      "webhookId": "telegram-name-webhook"
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "=Ø´ÙƒØ±Ø§Ù‹ {{ $json.message.text }}! ðŸ‘‹\n\nØ§Ù„Ø¢Ù† Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªÙ‡ØªÙ… Ø¨Ù‡Ø§:\n(ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø¬Ø§Ù„)",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "buttons": [
                {
                  "text": "ðŸ’» ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª",
                  "callbackData": "cat_IT"
                },
                {
                  "text": "âš™ï¸ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©",
                  "callbackData": "cat_Engineering"
                }
              ]
            },
            {
              "buttons": [
                {
                  "text": "ðŸ¥ Ø§Ù„Ø·Ø¨ ÙˆØ§Ù„ØµØ­Ø©",
                  "callbackData": "cat_Medical"
                },
                {
                  "text": "ðŸ’° Ø§Ù„Ù…Ø§Ù„ÙŠØ©",
                  "callbackData": "cat_Finance"
                }
              ]
            },
            {
              "buttons": [
                {
                  "text": "ðŸ“Š Ø§Ù„ØªØ³ÙˆÙŠÙ‚",
                  "callbackData": "cat_Marketing"
                },
                {
                  "text": "ðŸ“š Ø§Ù„ØªØ¹Ù„ÙŠÙ…",
                  "callbackData": "cat_Education"
                }
              ]
            },
            {
              "buttons": [
                {
                  "text": "ðŸ¢ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
                  "callbackData": "cat_Administration"
                },
                {
                  "text": "ðŸ“‹ Ø£Ø®Ø±Ù‰",
                  "callbackData": "cat_Other"
                }
              ]
            },
            {
              "buttons": [
                {
                  "text": "âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±",
                  "callbackData": "confirm_categories"
                }
              ]
            }
          ]
        }
      },
      "name": "Ask for Categories",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1120,
        500
      ],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Store user data temporarily\nconst telegram_id = $input.item.json.message.from.id;\nconst name = $input.item.json.message.text;\nconst username = $input.item.json.message.from.username || '';\n\n// Store in workflow static data for next steps\nreturn {\n  json: {\n    telegram_id: telegram_id,\n    name: name,\n    username: username,\n    categories: [],\n    step: 'waiting_categories'\n  }\n};"
      },
      "name": "Store Name Data",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1120,
        640
      ]
    },
    {
      "parameters": {
        "updates": [
          "callback_query"
        ]
      },
      "name": "Category Selection Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        1340,
        500
      ],
      "webhookId": "telegram-category-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Handle category selection\nconst callback_data = $input.item.json.callback_query.data;\nconst telegram_id = $input.item.json.callback_query.from.id;\n\n// Get existing data from workflow\nlet userData = $input.first().json;\n\nif (callback_data.startsWith('cat_')) {\n  const category = callback_data.replace('cat_', '');\n  \n  if (!userData.categories) {\n    userData.categories = [];\n  }\n  \n  // Toggle category\n  if (userData.categories.includes(category)) {\n    userData.categories = userData.categories.filter(c => c !== category);\n  } else {\n    userData.categories.push(category);\n  }\n  \n  return {\n    json: {\n      ...userData,\n      action: 'category_toggled',\n      message: `ØªÙ… ${userData.categories.includes(category) ? 'Ø¥Ø¶Ø§ÙØ©' : 'Ø¥Ø²Ø§Ù„Ø©'} ${category}`\n    }\n  };\n} else if (callback_data === 'confirm_categories') {\n  if (!userData.categories || userData.categories.length === 0) {\n    return {\n      json: {\n        ...userData,\n        action: 'error',\n        message: 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¬Ø§Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!'\n      }\n    };\n  }\n  \n  return {\n    json: {\n      ...userData,\n      action: 'confirmed',\n      ready_to_save: true\n    }\n  };\n}\n\nreturn { json: userData };"
      },
      "name": "Process Categories",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        1560,
        500
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action }}",
              "value2": "confirmed"
            }
          ]
        }
      },
      "name": "Check Confirmation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1780,
        500
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/users",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.SUPABASE_ANON_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "telegram_id",
              "value": "={{ $json.telegram_id }}"
            },
            {
              "name": "name",
              "value": "={{ $json.name }}"
            },
            {
              "name": "username",
              "value": "={{ $json.username }}"
            },
            {
              "name": "categories",
              "value": "={{ JSON.stringify($json.categories) }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Save to Supabase",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2000,
        400
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_id }}",
        "text": "=ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ðŸŽ‰\n\nØ§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:\n{{ $json.categories.map(c => 'â€¢ ' + c).join('\\n') }}\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¹ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ø§Ù„Ø¢Ù† Ù„ØªØ­Ø³ÙŠÙ† Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«ØŸ",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "buttons": [
                {
                  "text": "ðŸ“„ Ø±ÙØ¹ Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©",
                  "callbackData": "upload_cv"
                }
              ]
            },
            {
              "buttons": [
                {
                  "text": "â­ï¸ ØªØ®Ø·ÙŠ Ø§Ù„Ø¢Ù†",
                  "callbackData": "skip_cv"
                }
              ]
            }
          ]
        }
      },
      "name": "Registration Complete",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        2220,
        400
      ],
      "credentials": {
        "telegramApi": {
          "id": "1",
          "name": "Telegram Bot API"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.callback_query.message.chat.id }}",
        "text": "=Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:\n{{ $json.categories.map(c => 'â€¢ ' + c).join('\\n') }}\n\nâœ… Ø§Ø¶ØºØ· ØªØ£ÙƒÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡",
        "additionalFields": {}
      },
      "name": "Update Category List",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1780,
        700
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/user_interactions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SECRET_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.SUPABASE_SECRET_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $json.id }}"
            },
            {
              "name": "action",
              "value": "registration_completed"
            },
            {
              "name": "details",
              "value": "={{ JSON.stringify({ categories: $json.categories }) }}"
            }
          ]
        }
      },
      "name": "Log Interaction",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2220,
        600
      ]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Check Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Command": {
      "main": [
        [
          {
            "node": "Send Welcome Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Callback Trigger": {
      "main": [
        [
          {
            "node": "Check Register Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Register Callback": {
      "main": [
        [
          {
            "node": "Ask for Name",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Name": {
      "main": [
        [
          {
            "node": "Store Name Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Ask for Categories",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Category Selection Trigger": {
      "main": [
        [
          {
            "node": "Process Categories",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Categories": {
      "main": [
        [
          {
            "node": "Check Confirmation",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Category List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Confirmation": {
      "main": [
        [
          {
            "node": "Save to Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save to Supabase": {
      "main": [
        [
          {
            "node": "Registration Complete",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log Interaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {},
  "staticData": null,
  "tags": [],
  "pinData": {},
  "versionId": "1"
}
